<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="robots" content="noindex" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Content Manager</title>
  </head>
  <body>
    <script>
      // Use a relative config path so it works locally and on GitHub Pages
      window.CMS_CONFIG_PATH = "config.yml?v=4";
    </script>
    <script src="https://unpkg.com/decap-cms@^3/dist/decap-cms.js"></script>
    <script>
      // Editor component: Insert aligned/sized images using markdown-it-attrs classes
      if (window.CMS) {
        // Make the preview match site theme and remove any image overlay/borders in the CMS preview iframe
        CMS.registerPreviewStyle(
          `
          :root { --bg:#0b0b0c; --text:#e7e7ea; --border:#2a2a31; --radius:12px; }
          html, body { background: var(--bg) !important; color: var(--text) !important; }
          img { background: transparent !important; border: 0 !important; box-shadow: none !important; }
          .img-rounded { border: 0 !important; border-radius: var(--radius) !important; }
          /* Ensure height utility images don't get white background */
          .img-h-200, .img-h-300, .img-h-400, .img-h-500 { background: transparent !important; }
        `,
          { raw: true }
        );

        CMS.registerEditorComponent({
          id: "aligned-image",
          label: "Image (aligned)",
          fields: [
            { name: "src", label: "Image", widget: "image" },
            {
              name: "url",
              label: "Image URL (optional link)",
              widget: "string",
              required: false,
            },
            {
              name: "alt",
              label: "Alt text",
              widget: "string",
              required: false,
            },
            {
              name: "rounded",
              label: "Rounded corners",
              widget: "boolean",
              default: false,
              required: false,
            },
            {
              name: "align",
              label: "Align",
              widget: "select",
              options: [
                { label: "Left", value: "left" },
                { label: "Center", value: "center" },
                { label: "Right", value: "right" },
              ],
              default: "center",
            },
            {
              name: "size",
              label: "Size",
              widget: "select",
              options: [
                { label: "Small (33%)", value: "small" },
                { label: "Medium (66%)", value: "medium" },
                { label: "Full (100%)", value: "full" },
              ],
              default: "medium",
            },
            {
              name: "height",
              label: "Height",
              widget: "select",
              options: [
                { label: "Auto", value: "auto" },
                { label: "200px", value: "200" },
                { label: "300px", value: "300" },
                { label: "400px", value: "400" },
                { label: "500px", value: "500" },
              ],
              default: "auto",
            },
            {
              name: "fade",
              label: "Gradient fade",
              widget: "select",
              options: [
                { label: "None", value: "none" },
                { label: "Top/Bottom", value: "top-bottom" },
                { label: "Left/Right", value: "left-right" },
                { label: "All Sides", value: "all" },
                { label: "All Extreme", value: "all-extreme" },
              ],
              default: "none",
            },
          ],
          // Match either HTML <img ...> with classes, or markdown image plus attributes (same or next lines)
          pattern:
            /(?:<img\s+[^>]*>)|(?:!\[[^\]]*?\]\([^)]*?\)[ \t]*(?:\r?\n[ \t]*)*\{[^}]*\})/m,
          fromBlock: function (match) {
            const raw = match[0];
            let alt = "";
            let src = "";
            let align = "center";
            let size = "medium";
            let height = "auto";
            let fade = "none";
            let rounded = false;
            if (raw.startsWith("<img")) {
              const srcMatch = raw.match(/src=["']([^"']+)["']/i);
              const altMatch = raw.match(/alt=["']([^"']*)["']/i);
              const classMatch = raw.match(/class=["']([^"']*)["']/i);
              src = srcMatch ? srcMatch[1] : "";
              alt = altMatch ? altMatch[1] : "";
              const classes = (classMatch ? classMatch[1] : "").split(/\s+/);
              classes.forEach((t) => {
                if (t === "img-left") align = "left";
                else if (t === "img-center") align = "center";
                else if (t === "img-right") align = "right";
                else if (t === "img-small") size = "small";
                else if (t === "img-medium") size = "medium";
                else if (t === "img-full") size = "full";
                else if (t.startsWith("img-h-")) {
                  const h = t.replace("img-h-", "");
                  if (/^\d+$/.test(h)) height = h;
                } else if (t.startsWith("img-fade-")) {
                  const f = t.replace("img-fade-", "");
                  if (f === "top-bottom") fade = "top-bottom";
                  else if (f === "left-right") fade = "left-right";
                  else if (f === "all") fade = "all";
                  else if (f === "all-extreme") fade = "all-extreme";
                } else if (t === "img-rounded") {
                  rounded = true;
                }
              });
            } else {
              const mAlt = raw.match(/!\[([^\]]*)\]/);
              const mSrc = raw.match(/\(([^)]+)\)/);
              const mAttr = raw.match(/\{([^}]*)\}/);
              alt = mAlt ? mAlt[1] : "";
              src = mSrc ? mSrc[1] : "";
              const attrStr = (mAttr ? mAttr[1] : "").trim();
              const tokens = attrStr.split(/\s+/);
              tokens.forEach((t) => {
                if (!t) return;
                if (t === ".img-left") align = "left";
                else if (t === ".img-center") align = "center";
                else if (t === ".img-right") align = "right";
                else if (t === ".img-small") size = "small";
                else if (t === ".img-medium") size = "medium";
                else if (t === ".img-full") size = "full";
                else if (t.startsWith(".img-h-")) {
                  const h = t.replace(".img-h-", "");
                  if (/^\d+$/.test(h)) height = h;
                } else if (t.startsWith(".img-fade-")) {
                  const f = t.replace(".img-fade-", "");
                  if (f === "both" || f === "top-bottom") fade = "top-bottom";
                  else if (f === "sides" || f === "left-right")
                    fade = "left-right";
                  else if (f === "all") fade = "all";
                  else if (f === "all-extreme") fade = "all-extreme";
                } else if (t === ".img-rounded") {
                  rounded = true;
                }
              });
            }
            // Extract URL from href attribute if present
            let url = "";
            if (raw.startsWith("<img")) {
              const hrefMatch = raw.match(/href=["']([^"']+)["']/i);
              url = hrefMatch ? hrefMatch[1] : "";
            } else {
              // Check for markdown link syntax: [![alt](src)](url)
              const linkMatch = raw.match(/\]\(([^)]+)\)/);
              if (linkMatch && linkMatch[1] && !linkMatch[1].match(/\.(jpg|jpeg|png|gif|webp|svg)/i)) {
                url = linkMatch[1];
              }
            }
            return { alt, src, url, align, size, height, fade, rounded };
          },
          toBlock: function ({
            src,
            url,
            alt,
            rounded = false,
            align = "center",
            size = "medium",
            height = "auto",
            fade = "none",
          }) {
            if (!src) return "";
            const hClass = height !== "auto" ? ` img-h-${height}` : "";
            const fClass = fade !== "none" ? ` img-fade-${fade}` : "";
            const rClass = rounded ? ` img-rounded` : "";
            const cls =
              `img-${align} img-${size}${hClass}${fClass}${rClass}`.trim();
            const imgTag = `<img src="${src}" alt="${alt || ""}" class="${cls}">`;
            if (url) {
              return `<a href="${url}">${imgTag}</a>`;
            }
            return imgTag;
          },
          toPreview: function ({
            src,
            url,
            alt,
            rounded = false,
            align = "center",
            size = "medium",
            height = "auto",
            fade = "none",
          }) {
            if (!src) return "";
            const hClass = height !== "auto" ? ` img-h-${height}` : "";
            const fClass = fade !== "none" ? ` img-fade-${fade}` : "";
            const rClass = rounded ? ` img-rounded` : "";
            const imgTag = `<img src="${src}" alt="${
              alt || ""
            }" class="img-${align} img-${size}${hClass}${fClass}${rClass}" />`;
            if (url) {
              return `<a href="${url}">${imgTag}</a>`;
            }
            return imgTag;
          },
        });
      }
    </script>
  </body>
</html>
